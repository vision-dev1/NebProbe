import json
import os
from utils.config import Config

class VulnerabilityCheck:
    def __init__(self):
        self.risky_services = self._load_data()

    def _load_data(self):
        if not os.path.exists(Config.RISKY_SERVICES_FILE):
            return {"risky_ports": [], "services": {}, "versions": {}}
        with open(Config.RISKY_SERVICES_FILE, 'r') as f:
            return json.load(f)

    def assess_risk(self, port, service_name, version):
        risk_level = "Info"
        reason = "Open port detected"
        
        for bad_version, info in self.risky_services.get("versions", {}).items():
            if bad_version.lower() in (str(version) + str(service_name)).lower():
                return info.get("risk", "High"), info.get("description", "Vulnerable version known")

        if service_name in self.risky_services.get("services", {}):
            s_info = self.risky_services["services"][service_name]
            risk_level = s_info.get("risk", "Info")
            reason = s_info.get("description", "Risky service")
        
        elif port in self.risky_services.get("risky_ports", []):
             risk_level = "Medium"
             reason = "Potentially risky port"

        return risk_level, reason
